openapi: 3.0.1
info:
  title: Dhaam Order Service API
  description: |
    Comprehensive API documentation for Dhaam Order Service.
    Manages orders, quotations, order status updates, and order exports.
  version: 1.0.0
  contact:
    name: Chirag Sharma
    email: chirag@dhaam.com

servers:
  - url: https://dev-nexus.dhaamai.com/api/v1/orders
    description: Dev server
  - url: https://staging-nexus.dhaamai.com/api/v1/orders
    description: Staging server
  - url: https://test-nexus.dhaamai.com/api/v1/orders
    description: Testing server

security:
  - ApiKeyAuth: []

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: API Key authentication

  parameters:
    OrderIdPath:
      name: id
      in: path
      required: true
      description: Order ID or UUID
      schema:
        type: string

  schemas:
    # ==================== Domain Models ====================

    Order:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        order_id:
          type: integer
          format: int64
          example: 1001
        order_type:
          type: integer
          example: 1
        order_type_name:
          type: string
          example: "Dine In"
        delivery_mode:
          type: integer
          example: 0
        delivery_mode_name:
          type: string
          example: "ASAP"
        order_status:
          type: integer
          example: 1
        orcder_status_name:
          type: string
          example: "Pending"
        order_source:
          type: integer
          example: 1
        order_source_name:
          type: string
          example: "Mobile App"
        cart_total:
          type: number
          format: double
          example: 500.00
        total_tax:
          type: number
          format: double
          example: 50.00
        delivery_charge:
          type: number
          format: double
          example: 30.00
        total_discount:
          type: number
          format: double
          example: 20.00
        placed_at:
          type: string
          format: date-time
          example: "2024-12-02T10:30:00Z"
        updated_at:
          type: string
          format: date-time
          example: "2024-12-02T11:00:00Z"
        delivery_address:
          type: string
          example: "123 Main St, City, State 12345"
        client_request_id:
          type: string
          example: "req_12345"
        last_platform_used:
          type: string
          example: "ios"
        order_information:
          type: object
          additionalProperties: true
          description: Dynamic order metadata
        client_id:
          type: integer
          format: int64
          example: 1
        customer_id:
          type: integer
          format: int64
          example: 101
        customer_name:
          type: string
          example: "John Doe"
        customer_email:
          type: string
          format: email
          example: "john@example.com"
        customer_phone:
          type: string
          example: "+1234567890"
        customer_landmark:
          type: string
          example: "Near City Mall"
        outstanding_amount:
          type: number
          format: double
          example: 0.00
        store_id:
          type: integer
          format: int64
          example: 5
        store_name:
          type: string
          example: "Downtown Store"
        phone_number:
          type: string
          example: "+1234567890"
        email:
          type: string
          format: email
          example: "store@example.com"
        country_code:
          type: string
          example: "US"
        payment_mode:
          type: integer
          example: 1
        payment_mode_name:
          type: string
          example: "Cash"
        total_amount:
          type: number
          format: double
          example: 560.00
        delivery_time:
          type: integer
          example: 30
          description: Delivery time in minutes
        latitude:
          type: number
          format: double
          example: 40.7128
        longitude:
          type: number
          format: double
          example: -74.0060
        schedule_for:
          type: string
          format: date-time
          example: "2024-12-02T15:00:00Z"
        order_prep_time:
          type: integer
          example: 20
          description: Order preparation time in minutes
        items:
          type: array
          items:
            $ref: '#/components/schemas/OrderItem'
        event:
          $ref: '#/components/schemas/OrderEvent'
        events:
          type: array
          items:
            $ref: '#/components/schemas/OrderEvent'

    OrderItem:
      type: object
      properties:
        id:
          type: string
          format: uuid
        order_id:
          type: integer
          format: int64
        item_id:
          type: integer
          format: int64
        link_id:
          type: string
        group_id:
          type: integer
          format: int64
        modifier_group_id:
          type: integer
          format: int64
        display_name:
          type: string
        name:
          type: string
        type:
          type: string
        quantity:
          type: integer
        mrp:
          type: number
          format: double
        amount:
          type: number
          format: double
        total_amount:
          type: number
          format: double
        tax_amount:
          type: number
          format: double
        discount_amount:
          type: number
          format: double
        inventory_enabled:
          type: boolean
        status:
          type: integer
          format: int64
        picked_time:
          type: string
          format: date-time
        finish_time:
          type: string
          format: date-time
        notes:
          type: string

    OrderEvent:
      type: object
      properties:
        id:
          type: string
          format: uuid
        order_id:
          type: integer
          format: int64
        statusInt:
          type: integer
          format: int64
        status:
          type: string
        changed_by:
          type: integer
          format: int64
        actor_type:
          type: string
        update_source_id:
          type: integer
          format: int64
        changed_at:
          type: string
          format: date-time
        note:
          type: string
        is_active:
          type: boolean

    # ==================== Request Schemas ====================

    QuoteRequest:
      type: object
      required:
        - customer_id
        - address
        - latitude
        - longitude
        - payment_via
        - store_id
        - items
      properties:
        quotation_id:
          type: string
          format: uuid
          description: Existing quotation ID for updates
        customer_id:
          type: integer
          format: int64
          example: 101
        address:
          type: string
          minLength: 5
          example: "123 Main St, City, State 12345"
        latitude:
          type: number
          format: double
          example: 40.7128
        longitude:
          type: number
          format: double
          example: -74.0060
        delivery_mode:
          type: integer
          example: 0
          description: "0 = ASAP, 1 = Scheduled"
        order_mode:
          type: integer
          example: 0
          description: "0 = Delivery, 1 = Pickup"
        scheduled_for:
          type: string
          format: date-time
          example: "2024-12-02T15:00:00Z"
        payment_via:
          type: integer
          example: 1
          description: Payment mode ID
        wallet_money:
          type: number
          format: double
          example: 50.00
        loyalty_points:
          type: integer
          example: 100
        store_id:
          type: integer
          format: int64
          example: 5
        items:
          type: array
          minItems: 1
          items:
            type: object
            required:
              - item_id
              - quantity
              - total_amount
              - notes
            properties:
              item_id:
                type: integer
                format: int64
              quantity:
                type: integer
                minimum: 1
              total_amount:
                type: number
                format: double
              notes:
                type: string
        flat_discount:
          type: number
          format: double
          example: 20.00
        tips:
          type: number
          format: double
          example: 10.00
        promo_code:
          type: string
          maxLength: 50
          example: "SAVE20"
        notes:
          type: string
          maxLength: 200
          example: "Please ring the doorbell"
        utensils:
          type: object
          properties:
            send_cutlery:
              type: boolean
              example: true
            carry_bag:
              type: boolean
              example: true
        expires_at:
          type: string
          format: date-time
          example: "2024-12-02T16:00:00Z"

    CreateOrderRequest:
      type: object
      required:
        - quotation_id
      properties:
        quotation_id:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"

    OrderStatusUpdateRequest:
      type: object
      required:
        - status
      properties:
        status:
          type: integer
          format: int64
          example: 2
          description: New status code
        refund_amount:
          type: number
          format: double
          example: 100.00
          description: Optional refund amount
        metadata:
          type: object
          additionalProperties: true
          description: Dynamic metadata key-value pairs

    GetOrdersRequest:
      type: object
      required:
        - current_page
        - previous_page
        - limit
      properties:
        start_time:
          type: string
          format: date-time
          example: "2024-12-01T00:00:00Z"
        end_time:
          type: string
          format: date-time
          example: "2024-12-02T23:59:59Z"
        current_page:
          type: integer
          example: 1
        previous_page:
          type: integer
          example: 0
        limit:
          type: integer
          example: 20
        store_id:
          type: integer
          example: 5
        role_id:
          type: integer
          example: 1
        filters:
          $ref: '#/components/schemas/OrderFilters'
        sort:
          $ref: '#/components/schemas/OrderSort'

    OrderFilters:
      type: object
      properties:
        platform_used:
          type: array
          items:
            type: integer
          example: [1, 2]
        delivery_mode:
          type: array
          items:
            type: integer
          example: [0, 1]
        order_type:
          type: array
          items:
            type: integer
          example: [1]
        store_ids:
          type: array
          items:
            type: integer
          example: [5, 6]
        payment_modes:
          type: array
          items:
            type: integer
          example: [1, 2]
        status:
          type: integer
          example: 1
        search_text:
          type: string
          example: "John Doe"
        user_id:
          type: string
          example: "user_123"

    OrderSort:
      type: object
      properties:
        sort_by:
          type: string
          example: "placed_at"
        sort_order:
          type: integer
          example: 1
          description: "0 = ascending, 1 = descending"

    ExportReportRequest:
      type: object
      required:
        - client_id
        - email
        - filter
      properties:
        client_id:
          type: integer
          format: int64
          example: 1
        email:
          type: string
          format: email
          example: "admin@example.com"
        filter:
          type: object
          required:
            - start_date
            - end_date
          properties:
            start_date:
              type: string
              format: date-time
              example: "2024-12-01T00:00:00Z"
            end_date:
              type: string
              format: date-time
              example: "2024-12-31T23:59:59Z"

    # ==================== Response Schemas ====================

    SuccessResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
        meta:
          type: object

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: object
          properties:
            code:
              type: string
            message:
              type: string

paths:
  # ==================== Order Endpoints ====================

  /quote:
    post:
      tags:
        - Quote
      summary: Create or update quotation
      description: Creates a new quotation or updates an existing one with cart details and pricing
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/QuoteRequest'
      responses:
        '200':
          description: Quotation created/updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      quotation_id:
                        type: string
                        format: uuid
                      cart_total:
                        type: number
                        format: double
                      total_tax:
                        type: number
                        format: double
                      delivery_charge:
                        type: number
                        format: double
                      total_discount:
                        type: number
                        format: double
                      total_amount:
                        type: number
                        format: double
                      expires_at:
                        type: string
                        format: date-time
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /create:
    post:
      tags:
        - Order
      summary: Create order from quotation
      description: Creates a new order from an existing quotation
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateOrderRequest'
      responses:
        '200':
          description: Order created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/Order'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /list:
    post:
      tags:
        - Order
      summary: Get orders with pagination
      description: Retrieves paginated list of orders with optional filters and sorting
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetOrdersRequest'
      responses:
        '200':
          description: Orders retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Order'
                  meta:
                    type: object
                    properties:
                      total_count:
                        type: integer
                        example: 100
                      current_page:
                        type: integer
                        example: 1
                      total_pages:
                        type: integer
                        example: 5
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /{id}:
    get:
      tags:
        - Order
      summary: Get order details
      description: Retrieves complete details of a specific order by ID
      security:
        - ApiKeyAuth: []
      parameters:
        - $ref: '#/components/parameters/OrderIdPath'
      responses:
        '200':
          description: Order details retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/Order'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Order not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    post:
      tags:
        - Order
      summary: Update order status
      description: Updates the status of an order with optional refund and metadata
      security:
        - ApiKeyAuth: []
      parameters:
        - $ref: '#/components/parameters/OrderIdPath'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OrderStatusUpdateRequest'
      responses:
        '200':
          description: Order status updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/Order'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Order not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /export:
    post:
      tags:
        - Order
      summary: Export orders report
      description: Exports orders data as a report and sends it to the provided email
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ExportReportRequest'
      responses:
        '200':
          description: Export request submitted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      message:
                        type: string
                        example: "Report will be sent to your email shortly"
                      request_id:
                        type: string
                        format: uuid
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

tags:
  - name: Quote
    description: Quotation management endpoints
  - name: Order
    description: Order management endpoints
